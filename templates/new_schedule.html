{% extends "Master.html" %}

{% block title %}New Schedule{% endblock %}
{% block head %}
    <script>
    function updateElementIndex(object, prefix, index) {
		var id_regex = new RegExp('(' + prefix + '-\\d+)');
		var replacement = prefix + '-' + index;
		if ($(object).attr("for")) $(object).attr("for", $(object).attr("for").replace(id_regex, replacement));
		if (object.id) object.id = object.id.replace(id_regex, replacement);
		if (object.name) object.name = object.name.replace(id_regex, replacement);
        if (object.className && object.className == "delete-button")
            $(object).removeAttr("onclick").unbind().click(function () {
                    RemoveRowClick(index+1, prefix);
            });
	}
    function buttonDayClick() {

    }
    function AddRowClick(prefix) {
        try {
            var form_count = parseInt($('#id_' + prefix + '-TOTAL_FORMS').val());
            if(form_count == 1 ) //if there was only one row, enable the delete button again
            {
                var table = document.getElementById(prefix + 'Table');
                var lastDeleteButton = table.rows[1].cells[0].children[0];
                lastDeleteButton.disabled = false;
            }
            var row = $('.dynamic-' + prefix + '-row:first').clone(true).get(0);
            row.id = prefix + '-row-' + (form_count+1); //table row number starting at 1
            $(row).insertAfter($('.dynamic-' + prefix + '-row:last'));
            $(row).children().children().each(function () {
                updateElementIndex(this, prefix, form_count);
                $(this).val('');
            });
            if(prefix == "RN")
                row.cells[1].textContent =  'Nurse ' + (form_count + 1);
            $('#id_' + prefix + '-TOTAL_FORMS').val(form_count + 1);
        }catch(e) {
            alert(e);
        }
    }
    function RemoveRowClick(rowIndex, prefix){
         var form_count = parseInt($('#id_' + prefix + '-TOTAL_FORMS').val());
         try {
            var table = document.getElementById(prefix + 'Table');
            table.deleteRow(rowIndex);

            for(var tableIndex=1; tableIndex < form_count; tableIndex++) {
                var row = table.rows[tableIndex];
                var RNNumber = tableIndex - 1;
                if(row.id.split('-')[2] != tableIndex) { //If the ID does not match the row number
                    row.id = prefix + '-row-' + tableIndex;
                    $(row).children().children().each(function () {
                        updateElementIndex(this, prefix, RNNumber);
                    });
                    if(prefix == "RN")
                        row.cells[1].textContent =  'Nurse ' + tableIndex;
                }//end if
            }//end for loop
             $('#id_' + prefix + '-TOTAL_FORMS').val(--form_count);
            }catch(e) {
                alert(e);
            }
        if(form_count == 1 ) //if there is now only one row left, disable delete button
        {
            var lastDeleteButton = table.rows[1].cells[0].children[0];
            lastDeleteButton.disabled = true;
        }
    }
    </script>
{% endblock %}

{% block content %}
    <h4 class="text-center">Create New Schedule</h4>
    <form method="POST" action="/newSchedule/">
    {% csrf_token %}
    <div>
        <h3>Schedule Period</h3>
        <button id="buttonDay" type="button" class="btn btn-primary" onclick="buttonDayClick()" >Day</button>
        <button id="buttonWeek" type="button"  class="btn btn-primary" disabled="disabled">Week</button>
        <button id="buttonMonth"  class="btn btn-primary" disabled="disabled">Month</button>
        <hr>
    </div>
    <div>
        <h3>RN Schedules</h3>
        {{ ChairsForm }}
        <button type="button" class="btn btn-primary" style="float: right;">Load Nurse Schedule</button><br><br>
        {{ RNFormSet.management_form }}
        <table id="{{ RNFormSet.prefix }}Table" class='table table-striped'>
        <tr>
            <th></th>
            <th></th>
            <th>Pod Team</th>
            <th>Start Time</th>
            <th>Lunch Time</th>
            <th>Lunch Duration</th>
            <th>End Time</th>
        </tr>
        {% for form in RNFormSet.forms %}
            {% if form.errors %}
                <div class="alert alert-danger">
                    <a href="#" class="close" data-dismiss="alert" aria-label="close">&times;</a>
                    {{ form.non_field_errors | striptags }} at Nurse {{ forloop.counter }}
                </div>
            {% endif %}
            <tr id="{{ RNFormSet.prefix }}-row-{{ forloop.counter }}" class="dynamic-{{ RNFormSet.prefix }}-row">
                <td>
                    <button type="button" aria-label="Delete" class="delete-button" onclick="RemoveRowClick({{ forloop.counter }}, '{{ RNFormSet.prefix }}')"><span class="glyphicon glyphicon-minus" aria-hidden="true"></span></button>
                </td>
                <td class="RNNumber">Nurse {{ forloop.counter }}</td>
                <td>{{ form.Team }}</td>
                <td>{{ form.StartTime }}</td>
                <td>{{ form.LunchTime }}</td>
                <td>{{ form.LunchDuration }}</td>
                <td>{{ form.EndTime }}</td>
            </tr>
        {% endfor %}
            <tr><td colspan="6">
                <button type="button" aria-label="Add" onclick="AddRowClick('{{ RNFormSet.prefix }}')"><span class="glyphicon glyphicon-plus" aria-hidden="true"></span></button>
            </td></tr>
        </table>

        <br>
    <hr>
    </div>
    <div>
        <h3>Needed Timeslots</h3>
        {{ AppointmentFormSet.management_form }}
        <table id="{{ AppointmentFormSet.prefix }}Table" class='table table-striped'>
        <tr>
                <th></th>
                <th>Time Period</th>
                <th>Total Needed</th>
        </tr>
        {% for form in AppointmentFormSet.forms %}
            <tr id="{{ AppointmentFormSet.prefix }}-row-{{ forloop.counter }}" class="dynamic-{{ AppointmentFormSet.prefix }}-row">
                <td>
                    <button type="button" aria-label="Delete" class="delete-button" disabled="disabled" onclick="RemoveRowClick({{ forloop.counter }}, '{{ AppointmentFormSet.prefix }}')"><span class="glyphicon glyphicon-minus" aria-hidden="true"></span></button>
                </td>
                <td>{{ form.TimePeriod }}</td>
                <td>{{ form.Amount }}</td>
            </tr>
        {% endfor %}
        <tr><td colspan="6">
            <button type="button" aria-label="Add" onclick="AddRowClick('{{ AppointmentFormSet.prefix }}')"><span class="glyphicon glyphicon-plus" aria-hidden="true"></span></button>
        </td></tr>
        </table>
        <br>
        <button type="submit" class="btn btn-primary btn-lg">Submit</button><br><br>
    </div>
    </form>
    {#TODO Add transitions between steps#}
    <button type="button" class="btn btn-default"><span class="glyphicon glyphicon-chevron-left" aria-hidden="true"></span>Previous</button>
    <button type="button" class="btn btn-default">Next<span class="glyphicon glyphicon-chevron-right" aria-hidden="true"></span></button>
    <button type="button" class="btn btn-default" style="float: right;">Cancel</button>
{% endblock %}